box: wercker-labs/docker
build:
  steps:
    - script:
        name: 'Read Docker cache'
        code: |
          if [ -d "$WERCKER_CACHE_DIR/docker-cache" ]; then sudo rsync -az "$WERCKER_CACHE_DIR/docker-cache" "/var/lib/docker"; fi

    - script:
        name: 'Build docker image'
        code: |
          docker build -t statianzo/sinfail .

    - script:
        name: 'Build testing image'
        code: |
          docker run --name test_container statianzo/sinfail bundle --without ''
          docker commit test_container sinfailtest

    - script:
        name: 'Run tests'
        code: |
          docker run sinfailtest bundle exec rake test

    - script:
        name: 'Create artifacts'
        code: |
          mkdir -p $WERCKER_OUTPUT_DIR
          docker save statianzo/sinfail > $WERCKER_OUTPUT_DIR/sinfail.tar

    - script:
        name: 'Populate Docker Cache'
        code: |
          sudo rsync -az "/var/lib/docker" "$WERCKER_CACHE_DIR/docker-cache"

deploy:
  steps:
    - script:
        name: 'Import artifacts'
        code: |
          docker load < sinfail.tar

    - script:
        name: 'Authenticate docker'
        code: |
          docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USER" -p="$DOCKER_PASSWORD"

    - script:
        name: 'Push to docker registry'
        code: |
          docker push statianzo/sinfail
