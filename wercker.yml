box: wercker-labs/docker
build:
  steps:
    - script:
        name: 'Build docker image'
        code: |
          docker build -t statianzo/sinfail .

    - script:
        name: 'Build testing image'
        code: |
          docker run --name test_container statianzo/sinfail bundle --without ''
          docker commit test_container sinfailtest

    - script:
        name: 'Run tests'
        code: |
          docker run sinfailtest bundle exec rake test

    - script:
        name: 'Create artifacts'
        code: |
          mkdir -p $WERCKER_OUTPUT_DIR
          docker save statianzo/sinfail > $WERCKER_OUTPUT_DIR/sinfail.tar

deploy:
  steps:
    - script:
        name: 'Import artifacts'
        code: |
          id=$(docker load < $WERCKER_OUTPUT_DIR/sinfail.tar)
          docker tag $id statianzo/sinfail
          docker push statianzo/sinfail
